<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOORELEC V4 - Devis √âlectricien Pro</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-content">
                <div>
                    <div class="logo">‚ö° NOORELEC V4</div>
                    <div class="header-subtitle">Devis √âlectricien Professionnel</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="text-align: right;">
                        <div id="user-email" style="color: #fff; font-size: 0.9em; font-weight: 600;"></div>
                        <div id="user-status" style="color: rgba(255,255,255,0.8); font-size: 0.8em;"></div>
                    </div>
                    <button onclick="handleLogout()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        üö™ D√©connexion
                    </button>
                </div>
            </div>
        </header>

        <!-- NAVIGATION -->
        <nav class="nav-menu">
            <button class="nav-item active" data-page="client" onclick="switchPage('client')">
                <div class="nav-icon">üë§</div>
                <div class="nav-label">Client</div>
            </button>
            <button class="nav-item" data-page="travaux" onclick="switchPage('travaux')">
                <div class="nav-icon">üî®</div>
                <div class="nav-label">Travaux</div>
            </button>
            <button class="nav-item" data-page="tableau" onclick="switchPage('tableau')">
                <div class="nav-icon">‚ö°</div>
                <div class="nav-label">Tableau</div>
            </button>
            <button class="nav-item" data-page="administratif" onclick="switchPage('administratif')">
                <div class="nav-icon">üìã</div>
                <div class="nav-label">Admin</div>
            </button>
            <button class="nav-item" data-page="recapitulatif" onclick="switchPage('recapitulatif')">
                <div class="nav-icon">üí∞</div>
                <div class="nav-label">R√©cap</div>
            </button>
            <button class="nav-item" data-page="historique" onclick="switchPage('historique')">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Historique</div>
            </button>
            <button class="nav-item" data-page="schema" onclick="switchPage('schema')">
                <div class="nav-icon">üìê</div>
                <div class="nav-label">Sch√©mas</div>
            </button>
            <button class="nav-item" data-page="parametres" onclick="switchPage('parametres')">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Param</div>
            </button>
        </nav>

        <!-- PAGES -->
        <main class="app-content">
            
            <!-- PAGE CLIENT -->
            <div id="page-client" class="page active">
                <div class="section">
                    <h2 class="section-title">üë§ Informations Client</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nom complet *</label>
                            <input type="text" id="clientName" placeholder="Jean Dupont" onchange="saveClientData()">
                        </div>
                        <div class="form-group">
                            <label>T√©l√©phone</label>
                            <input type="tel" id="clientPhone" placeholder="+32 475 12 34 56" onchange="saveClientData()">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail" placeholder="jean@email.com" onchange="saveClientData()">
                        </div>
                        <div class="form-group">
                            <label>N¬∞ TVA (optionnel)</label>
                            <input type="text" id="clientTVA" placeholder="BE 0123.456.789" onchange="saveClientData()">
                        </div>
                        <div class="form-group full-width">
                            <label>Rue et num√©ro *</label>
                            <input type="text" id="clientRue" placeholder="Rue de la Paix 123" onchange="saveClientData()">
                        </div>
                        <div class="form-group">
                            <label>Code postal</label>
                            <input type="text" id="clientCP" placeholder="1000" onchange="saveClientData()">
                        </div>
                        <div class="form-group">
                            <label>Commune *</label>
                            <input type="text" id="clientCommune" placeholder="Bruxelles" onchange="saveClientData()">
                        </div>
                    </div>

                    <h3 class="subsection-title">üè† Type de projet</h3>
                    <div class="option-cards">
                        <label class="option-card active" onclick="selectProjectType('residential')">
                            <input type="radio" name="projectType" value="residential" checked>
                            <div class="card-icon">üè°</div>
                            <div class="card-title">R√©sidentiel</div>
                            <div class="card-subtitle">Maison, appartement</div>
                        </label>
                        <label class="option-card" onclick="selectProjectType('commercial')">
                            <input type="radio" name="projectType" value="commercial">
                            <div class="card-icon">üè¢</div>
                            <div class="card-title">Commercial</div>
                            <div class="card-subtitle">Bureau, magasin</div>
                        </label>
                    </div>

                    <h3 class="subsection-title">üìÖ √Çge du b√¢timent (d√©termine la TVA)</h3>
                    <div class="option-cards">
                        <label class="option-card active" onclick="selectBuildingAge('old')">
                            <input type="radio" name="buildingAge" value="old" checked>
                            <div class="card-icon">üèöÔ∏è</div>
                            <div class="card-title">> 10 ans</div>
                            <div class="card-subtitle" style="color: #28a745; font-weight: 700;">TVA 6%</div>
                        </label>
                        <label class="option-card" onclick="selectBuildingAge('new')">
                            <input type="radio" name="buildingAge" value="new">
                            <div class="card-icon">üèóÔ∏è</div>
                            <div class="card-title">< 10 ans</div>
                            <div class="card-subtitle" style="color: #dc3545; font-weight: 700;">TVA 21%</div>
                        </label>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="switchPage('travaux')">
                        Suivant : Travaux ‚Üí
                    </button>
                </div>
            </div>

            <!-- PAGE TRAVAUX -->
            <div id="page-travaux" class="page">
                <div class="section">
                    <h2 class="section-title">üî® Configuration des Travaux</h2>
                    
                    <!-- PARAM√àTRES GLOBAUX -->
                    <div class="global-settings">
                        <h3>‚öôÔ∏è Param√®tres globaux (appliqu√©s √† tous les articles)</h3>
                        
                        <div class="form-grid two-cols">
                            <div class="form-group">
                                <label><strong>Tarif horaire</strong></label>
                                <select id="globalTarif" onchange="updateGlobalSettings()">
                                    <option value="50" selected>Mod√©r√© - 50‚Ç¨/h</option>
                                    <option value="65">√âlev√© - 65‚Ç¨/h</option>
                                    <option value="75">Urgent - 75‚Ç¨/h</option>
                                    <option value="90">Week-end - 90‚Ç¨/h</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label><strong>D√©placement</strong></label>
                                <select id="globalDeplacement" onchange="updateGlobalSettings()">
                                    <option value="20">20‚Ç¨</option>
                                    <option value="25" selected>25‚Ç¨</option>
                                    <option value="35">35‚Ç¨</option>
                                    <option value="0">Gratuit</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- CR√âATION DE PI√àCE -->
                    <div class="section" style="background: linear-gradient(135deg, #e7f3ff 0%, #d1e7ff 100%); border: 3px solid #1e3c72; margin-bottom: 20px;">
                        <h3 style="color: #1e3c72; margin-bottom: 15px;">üè† Cr√©er une nouvelle pi√®ce</h3>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label><strong>Nom de la pi√®ce</strong></label>
                                <input type="text" id="newRoomName" placeholder="Ex: Salon, Cuisine, Chambre 1..." style="border: 2px solid #1e3c72;">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-success" onclick="createRoom()" style="margin-top: 24px; width: 100%;">
                                    ‚ûï Cr√©er cette pi√®ce
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- LISTE DES PI√àCES -->
                    <div id="roomsContainer">
                        <div class="empty-state">Cr√©ez une pi√®ce pour commencer</div>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="switchPage('tableau')">
                        Suivant : Tableau √©lectrique ‚Üí
                    </button>
                </div>
            </div>

            <!-- PAGE TABLEAU -->
            <div id="page-tableau" class="page">
                <div class="section">
                    <h2 class="section-title">‚ö° Tableau √âlectrique</h2>
                    
                    <div class="toggle-section">
                        <label class="toggle-label">
                            <span>Configuration tableau √©lectrique</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="tableauToggle" onchange="toggleTableau()">
                                <span class="toggle-slider"></span>
                            </label>
                        </label>
                    </div>

                    <div id="tableauContent" style="display: none;">
                        <div class="info-box">
                            <p>Configurez ici tous les composants du tableau √©lectrique. Vous pouvez cr√©er plusieurs tableaux (principal + interm√©diaires).</p>
                        </div>

                        <!-- LISTE DES TABLEAUX -->
                        <div id="tableauxContainer">
                            <!-- G√©n√©r√© dynamiquement -->
                        </div>

                        <button class="btn btn-success" onclick="createTableau()" style="margin-top: 15px; width: 100%;">
                            ‚ûï Ajouter un tableau
                        </button>

                        <div id="tableauGlobalTotal" class="section-total" style="margin-top: 20px;">
                            <strong>Total tableaux :</strong> <span id="tableauTotalPrice">0‚Ç¨</span> HTVA
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="switchPage('administratif')">
                        Suivant : Services administratifs ‚Üí
                    </button>
                </div>
            </div>

            <!-- PAGE ADMINISTRATIF -->
            <div id="page-administratif" class="page">
                <div class="section">
                    <h2 class="section-title">üìã Services Administratifs</h2>
                    
                    <div class="services-list">
                        <div class="service-item">
                            <label class="toggle-label">
                                <div class="service-info">
                                    <div class="service-name">Mise en conformit√©</div>
                                    <div class="service-price">450‚Ç¨</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" class="service-toggle" data-price="450" onchange="calculateAdmin()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                        </div>

                        <div class="service-item">
                            <label class="toggle-label">
                                <div class="service-info">
                                    <div class="service-name">Diagnostic √©lectrique complet</div>
                                    <div class="service-price">180‚Ç¨</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" class="service-toggle" data-price="180" onchange="calculateAdmin()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                        </div>

                        <div class="service-item">
                            <label class="toggle-label">
                                <div class="service-info">
                                    <div class="service-name">Certificat de conformit√©</div>
                                    <div class="service-price">80‚Ç¨</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" class="service-toggle" data-price="80" onchange="calculateAdmin()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                        </div>

                        <div class="service-item">
                            <label class="toggle-label">
                                <div class="service-info">
                                    <div class="service-name">R√©alisation sch√©ma √©lectrique</div>
                                    <div class="service-price">120‚Ç¨</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" class="service-toggle" data-price="120" onchange="calculateAdmin()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                        </div>

                        <div class="service-item hourly">
                            <label class="toggle-label">
                                <div class="service-info">
                                    <div class="service-name">
                                        D√©pannage
                                        <input type="number" id="depannageHours" value="2" min="0" step="0.5" style="width: 60px; margin-left: 10px;" onchange="calculateAdmin()">
                                        heures
                                    </div>
                                    <div class="service-price"><span id="depannagePrice">130‚Ç¨</span></div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" class="service-toggle" data-price="hourly" onchange="calculateAdmin()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                        </div>
                    </div>

                    <div id="adminTotal" class="section-total">
                        <strong>Total services :</strong> <span id="adminPrice">0‚Ç¨</span> HTVA
                    </div>

                    <button class="btn btn-primary btn-block" onclick="switchPage('recapitulatif')">
                        Voir le r√©capitulatif ‚Üí
                    </button>
                </div>
            </div>

            <!-- PAGE R√âCAPITULATIF -->
            <div id="page-recapitulatif" class="page">
                <div class="section">
                    <h2 class="section-title">üí∞ R√©capitulatif du Devis</h2>
                    
                    <div id="recapContent" class="recap-content">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>

                    <!-- RISTOURNE -->
                    <div class="section" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 3px solid #ffc107; margin-top: 20px;">
                        <h3 style="color: #856404; margin-bottom: 15px;">üí∞ Ristourne (optionnel)</h3>
                        
                        <label class="checkbox-option" style="background: white;">
                            <input type="checkbox" id="ristourneEnabled" onchange="updateRistourne()">
                            <div class="checkbox-content">
                                <div class="checkbox-title">Appliquer une ristourne</div>
                            </div>
                        </label>

                        <div id="ristourneOptions" style="display: none; margin-top: 15px;">
                            <div class="form-grid two-cols">
                                <div class="form-group">
                                    <label><strong>Pourcentage (%)</strong></label>
                                    <input type="number" id="ristournePourcent" value="10" min="0" max="100" step="1" onchange="updateRistourne()">
                                </div>
                                <div class="form-group">
                                    <label><strong>D√©lai de validit√© (jours)</strong></label>
                                    <input type="number" id="ristourneDelai" value="30" min="1" step="1" onchange="updateRistourne()">
                                </div>
                            </div>
                            <div id="ristournePreview" style="margin-top: 10px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #ffc107; font-weight: 700; color: #856404;">
                                <!-- Aper√ßu ristourne -->
                            </div>
                        </div>
                    </div>

                    <div class="recap-actions">
                        <button class="btn btn-success" onclick="generatePDF()">üìÑ G√©n√©rer PDF</button>
                        <button class="btn btn-secondary" onclick="resetDevis()">üîÑ Nouveau devis</button>
                    </div>
                </div>
            </div>

            <!-- PAGE HISTORIQUE -->
            <div id="page-historique" class="page">
                <div class="section">
                    <h2 class="section-title">üìä Historique des Devis</h2>
                    
                    <div class="info-box">
                        <p>Tous vos devis sauvegard√©s avec leur statut.</p>
                    </div>

                    <!-- FILTRES -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="filterDevis('all')">Tous</button>
                        <button class="btn" style="background: #28a745;" onclick="filterDevis('valide')">üü¢ Valid√©s</button>
                        <button class="btn" style="background: #ffc107; color: black;" onclick="filterDevis('attente')">üü† En attente</button>
                        <button class="btn" style="background: #dc3545;" onclick="filterDevis('refuse')">üî¥ Refus√©s</button>
                    </div>

                    <!-- LISTE DEVIS -->
                    <div id="devisHistoryList">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>
                </div>
            </div>

            <!-- PAGE SCHEMA (garder l'ancien) -->
            <div id="page-schema" class="page">
                <div class="section">
                    <h2 class="section-title">üìê Sch√©mas √âlectriques</h2>
                    <p>Page sch√©mas - √Ä impl√©menter</p>
                </div>
            </div>

            <!-- PAGE PARAMETRES -->
            <div id="page-parametres" class="page">
                <div class="section">
                    <h2 class="section-title">‚öôÔ∏è Param√®tres</h2>
                    
                    <div class="info-box">
                        <p>Personnalisez les prix de tous les articles, main d'≈ìuvre et services. Ces modifications s'appliqueront √† tous les futurs devis.</p>
                    </div>

                    <!-- TARIFS HORAIRES -->
                    <h3 class="subsection-title">‚è±Ô∏è Tarifs horaires (‚Ç¨/h)</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tarif Mod√©r√©</label>
                            <input type="number" id="param-tarif-50" value="50" step="1" min="0" onchange="saveSettings()">
                        </div>
                        <div class="form-group">
                            <label>Tarif √âlev√©</label>
                            <input type="number" id="param-tarif-65" value="65" step="1" min="0" onchange="saveSettings()">
                        </div>
                        <div class="form-group">
                            <label>Tarif Urgent</label>
                            <input type="number" id="param-tarif-75" value="75" step="1" min="0" onchange="saveSettings()">
                        </div>
                        <div class="form-group">
                            <label>Tarif Week-end</label>
                            <input type="number" id="param-tarif-90" value="90" step="1" min="0" onchange="saveSettings()">
                        </div>
                    </div>

                    <!-- ARTICLES CATALOGUE -->
                    <h3 class="subsection-title">üõí Prix des articles</h3>
                    <div id="catalogueEditor" style="display: grid; gap: 10px;">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>

                    <!-- SERVICES ADMINISTRATIFS -->
                    <h3 class="subsection-title">üìã Services administratifs</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mise en conformit√©</label>
                            <input type="number" id="param-conformite" value="450" step="10" min="0" onchange="saveSettings()">
                        </div>
                        <div class="form-group">
                            <label>Diagnostic √©lectrique</label>
                            <input type="number" id="param-diagnostic" value="180" step="10" min="0" onchange="saveSettings()">
                        </div>
                        <div class="form-group">
                            <label>Certificat de conformit√©</label>
                            <input type="number" id="param-certificat" value="80" step="5" min="0" onchange="saveSettings()">
                        </div>
                        <div class="form-group">
                            <label>R√©alisation sch√©ma</label>
                            <input type="number" id="param-schema" value="120" step="10" min="0" onchange="saveSettings()">
                        </div>
                    </div>

                    <!-- AUTRES -->
                    <h3 class="subsection-title">‚ûï Autres</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Rebouchage forfait</label>
                            <input type="number" id="param-rebouchage" value="20" step="5" min="0" onchange="saveSettings()">
                        </div>
                        <div class="form-group">
                            <label>D√©placement par d√©faut</label>
                            <input type="number" id="param-deplacement" value="25" step="5" min="0" onchange="saveSettings()">
                        </div>
                    </div>

                    <!-- AJOUTER ARTICLES PERSONNALIS√âS -->
                    <h3 class="subsection-title">üõ†Ô∏è Ajouter vos propres articles</h3>
                    <div class="article-form" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>‚ûï Nouvel article (pour onglet Travaux)</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nom de l'article</label>
                                <input type="text" id="customArticleName" placeholder="Ex: Borne de recharge">
                            </div>
                            <div class="form-group">
                                <label>Prix (‚Ç¨)</label>
                                <input type="number" id="customArticlePrice" placeholder="450" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Temps MO (heures)</label>
                                <input type="number" id="customArticleTemps" placeholder="2.5" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Cat√©gorie</label>
                                <select id="customArticleCategory">
                                    <option>Prises</option>
                                    <option>Interrupteurs</option>
                                    <option>√âclairage</option>
                                    <option>R√©seau</option>
                                    <option>Domotique</option>
                                    <option>S√©curit√©</option>
                                    <option>Autre</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addCustomArticle()">‚ûï Ajouter cet article</button>
                        
                        <div id="customArticlesList" style="margin-top: 15px;">
                            <!-- Liste articles personnalis√©s -->
                        </div>
                    </div>

                    <!-- AJOUTER COFFRETS PERSONNALIS√âS -->
                    <h3 class="subsection-title">üì¶ Ajouter vos propres coffrets</h3>
                    <div class="article-form" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>‚ûï Nouveau type de coffret (pour onglet Tableau)</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nom du coffret</label>
                                <input type="text" id="customCoffretName" placeholder="Ex: Coffret saillie 6R">
                            </div>
                            <div class="form-group">
                                <label>Prix (‚Ç¨)</label>
                                <input type="number" id="customCoffretPrice" placeholder="120" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Temps MO (heures)</label>
                                <input type="number" id="customCoffretTemps" placeholder="1.2" step="0.1" min="0">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addCustomCoffret()">‚ûï Ajouter ce coffret</button>
                        
                        <div id="customCoffretsList" style="margin-top: 15px;">
                            <!-- Liste coffrets personnalis√©s -->
                        </div>
                    </div>

                    <!-- AJOUTER COMPOSANTS PERSONNALIS√âS -->
                    <h3 class="subsection-title">‚ö° Ajouter vos propres composants</h3>
                    <div class="article-form" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>‚ûï Nouveau composant tableau (pour onglet Tableau)</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nom du composant</label>
                                <input type="text" id="customComposantName" placeholder="Ex: Disjoncteur diff√©rentiel">
                            </div>
                            <div class="form-group">
                                <label>Prix (‚Ç¨)</label>
                                <input type="number" id="customComposantPrice" placeholder="95" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Temps MO (heures)</label>
                                <input type="number" id="customComposantTemps" placeholder="0.3" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label>Cat√©gorie</label>
                                <select id="customComposantCategory">
                                    <option>Disjoncteurs</option>
                                    <option>Diff√©rentiels</option>
                                    <option>Protections</option>
                                    <option>Accessoires</option>
                                    <option>Terre</option>
                                    <option>Autre</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addCustomComposant()">‚ûï Ajouter ce composant</button>
                        
                        <div id="customComposantsList" style="margin-top: 15px;">
                            <!-- Liste composants personnalis√©s -->
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-success" onclick="saveSettings()">üíæ Sauvegarder</button>
                        <button class="btn btn-secondary" onclick="resetSettings()">üîÑ R√©initialiser</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
</body>
</html>
