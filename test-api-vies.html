<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API VIES - Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
            margin-bottom: 30px;
        }
        .test-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test-card h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background: #5568d3;
        }
        .result {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #60a5fa; }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic API VIES - V√©rification TVA</h1>
        
        <div class="test-card">
            <h3>Test 1 : V√©rifier ton TVA (BE0713814090)</h3>
            <p>V√©rifie si l'API VIES r√©pond avec ton num√©ro de TVA.</p>
            <button onclick="testVAT('BE0713814090')">üß™ Tester BE0713814090</button>
            <div id="result1" class="result" style="display: none;"></div>
        </div>

        <div class="test-card">
            <h3>Test 2 : TVA connu valide (Proximus - BE0202239951)</h3>
            <p>Test avec un TVA belge connu pour v√©rifier si l'API fonctionne.</p>
            <button onclick="testVAT('BE0202239951')">üß™ Tester Proximus</button>
            <div id="result2" class="result" style="display: none;"></div>
        </div>

        <div class="test-card">
            <h3>Test 3 : TVA invalide (BE0000000000)</h3>
            <p>Test avec un faux TVA pour voir la r√©ponse d'erreur.</p>
            <button onclick="testVAT('BE0000000000')">üß™ Tester TVA invalide</button>
            <div id="result3" class="result" style="display: none;"></div>
        </div>

        <div class="test-card">
            <h3>Test 4 : TVA personnalis√©</h3>
            <input type="text" id="customVAT" placeholder="BE 0123.456.789" 
                   style="padding: 12px; width: 300px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;">
            <button onclick="testCustomVAT()">üß™ Tester</button>
            <div id="result4" class="result" style="display: none;"></div>
        </div>

        <div id="summary" style="margin-top: 30px;"></div>
    </div>

    <script>
        let testResults = {
            total: 0,
            success: 0,
            failed: 0
        };

        function log(resultId, message, type = 'info') {
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#60a5fa'
            };
            resultDiv.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function clearLog(resultId) {
            document.getElementById(resultId).innerHTML = '';
            document.getElementById(resultId).style.display = 'none';
        }

        async function testVAT(vatNumber, resultId = null) {
            if (!resultId) {
                // D√©terminer le resultId en fonction du bouton cliqu√©
                if (vatNumber === 'BE0713814090') resultId = 'result1';
                else if (vatNumber === 'BE0202239951') resultId = 'result2';
                else if (vatNumber === 'BE0000000000') resultId = 'result3';
                else resultId = 'result4';
            }

            clearLog(resultId);
            log(resultId, `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'info');
            log(resultId, `üöÄ TEST DE V√âRIFICATION TVA: ${vatNumber}`, 'info');
            log(resultId, `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'info');
            
            const cleanVAT = vatNumber.replace(/[\s.\-]/g, '').toUpperCase();
            
            // V√©rifier le format
            if (!cleanVAT.match(/^BE[0-9]{10}$/)) {
                log(resultId, `‚ùå Format invalide`, 'error');
                log(resultId, `   Format attendu: BE suivi de 10 chiffres`, 'error');
                return;
            }

            const countryCode = cleanVAT.substring(0, 2);
            const vatNum = cleanVAT.substring(2);
            const apiUrl = `https://ec.europa.eu/taxation_customs/vies/rest-api/ms/${countryCode}/vat/${vatNum}`;

            log(resultId, `üì° URL API: ${apiUrl}`, 'info');
            log(resultId, ``, 'info');
            log(resultId, `‚è≥ Envoi de la requ√™te...`, 'warning');

            testResults.total++;

            try {
                const startTime = Date.now();
                
                // Timeout de 10 secondes
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const responseTime = Date.now() - startTime;

                log(resultId, `‚úÖ R√©ponse re√ßue en ${responseTime}ms`, 'success');
                log(resultId, `üìä Status HTTP: ${response.status} ${response.statusText}`, 'info');
                log(resultId, ``, 'info');

                if (response.ok) {
                    const data = await response.json();
                    
                    log(resultId, `üì¶ R√âPONSE JSON:`, 'success');
                    log(resultId, JSON.stringify(data, null, 2), 'success');
                    log(resultId, ``, 'info');

                    if (data.valid) {
                        log(resultId, `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'success');
                        log(resultId, `‚úÖ TVA VALIDE !`, 'success');
                        log(resultId, `   Entreprise: ${data.name || 'N/A'}`, 'success');
                        log(resultId, `   Adresse: ${data.address || 'N/A'}`, 'success');
                        log(resultId, `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'success');
                        testResults.success++;
                    } else {
                        log(resultId, `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'error');
                        log(resultId, `‚ùå TVA INVALIDE`, 'error');
                        log(resultId, `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'error');
                        testResults.failed++;
                    }
                } else if (response.status === 400) {
                    log(resultId, `‚ùå Erreur 400: TVA invalide ou mal format√©`, 'error');
                    testResults.failed++;
                } else if (response.status === 404) {
                    log(resultId, `‚ùå Erreur 404: TVA non trouv√©`, 'error');
                    testResults.failed++;
                } else if (response.status >= 500) {
                    log(resultId, `‚ùå Erreur ${response.status}: Serveur VIES indisponible`, 'error');
                    log(resultId, `   L'API europ√©enne a un probl√®me c√¥t√© serveur`, 'warning');
                    testResults.failed++;
                } else {
                    const text = await response.text();
                    log(resultId, `‚ö†Ô∏è R√©ponse inattendue:`, 'warning');
                    log(resultId, text.substring(0, 500), 'warning');
                    testResults.failed++;
                }

            } catch (error) {
                const errorType = error.name;
                
                log(resultId, `‚ùå ERREUR: ${errorType}`, 'error');
                log(resultId, `   Message: ${error.message}`, 'error');
                log(resultId, ``, 'info');

                if (errorType === 'AbortError') {
                    log(resultId, `‚è±Ô∏è TIMEOUT: L'API n'a pas r√©pondu en 10 secondes`, 'error');
                    log(resultId, `   ‚Üí L'API VIES est probablement surcharg√©e ou down`, 'warning');
                } else if (errorType === 'TypeError' && error.message.includes('Failed to fetch')) {
                    log(resultId, `üö´ ERREUR DE CONNEXION`, 'error');
                    log(resultId, `   Causes possibles:`, 'warning');
                    log(resultId, `   1. L'API VIES est compl√®tement down`, 'warning');
                    log(resultId, `   2. Probl√®me CORS (bloqu√© par le navigateur)`, 'warning');
                    log(resultId, `   3. Probl√®me de connexion internet`, 'warning');
                } else {
                    log(resultId, `   Stack: ${error.stack}`, 'error');
                }

                testResults.failed++;
            }

            updateSummary();
        }

        function testCustomVAT() {
            const vatInput = document.getElementById('customVAT').value;
            if (!vatInput) {
                alert('Veuillez entrer un num√©ro TVA');
                return;
            }
            testVAT(vatInput, 'result4');
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const successRate = testResults.total > 0 
                ? Math.round((testResults.success / testResults.total) * 100) 
                : 0;

            let statusClass = 'info';
            let statusIcon = '‚ÑπÔ∏è';
            let statusText = '';

            if (testResults.success === testResults.total && testResults.total > 0) {
                statusClass = 'success';
                statusIcon = '‚úÖ';
                statusText = 'L\'API VIES fonctionne parfaitement !';
            } else if (testResults.success === 0 && testResults.total > 0) {
                statusClass = 'error';
                statusIcon = '‚ùå';
                statusText = 'L\'API VIES est actuellement indisponible. Utilise le syst√®me de v√©rification manuelle.';
            } else if (testResults.total > 0) {
                statusClass = 'info';
                statusIcon = '‚ö†Ô∏è';
                statusText = 'L\'API VIES fonctionne partiellement. Syst√®me de secours recommand√©.';
            }

            if (testResults.total > 0) {
                summaryDiv.innerHTML = `
                    <div class="status ${statusClass}">
                        <h3>${statusIcon} R√©sum√© des tests</h3>
                        <p><strong>Total de tests:</strong> ${testResults.total}</p>
                        <p><strong>R√©ussis:</strong> ${testResults.success} ‚úÖ</p>
                        <p><strong>√âchou√©s:</strong> ${testResults.failed} ‚ùå</p>
                        <p><strong>Taux de r√©ussite:</strong> ${successRate}%</p>
                        <hr style="border: none; border-top: 1px solid currentColor; margin: 15px 0;">
                        <p><strong>Conclusion:</strong> ${statusText}</p>
                    </div>
                `;
            }
        }

        // Auto-scroll
        window.addEventListener('load', () => {
            console.log('Page de diagnostic charg√©e');
        });
    </script>
</body>
</html>
