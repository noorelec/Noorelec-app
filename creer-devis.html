<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevTech - Cr√©er un Devis</title>

```
<!-- CONSOLE MOBILE (POUR DEBUG iPHONE) -->
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

<!-- PDF Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    .app-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .app-header {
        background: white;
        border-radius: 15px;
        padding: 20px 30px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo {
        font-size: 28px;
        font-weight: bold;
        color: #667eea;
    }

    .back-btn {
        background: #667eea;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
    }

    .nav-menu {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding: 10px 0;
    }

    .nav-item {
        background: white;
        border: none;
        border-radius: 12px;
        padding: 15px 20px;
        min-width: 100px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .nav-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .nav-item.active {
        background: #667eea;
        color: white;
    }

    .nav-icon {
        font-size: 24px;
        text-align: center;
        margin-bottom: 5px;
    }

    .nav-label {
        text-align: center;
        font-size: 13px;
        font-weight: 600;
    }

    .page {
        display: none;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .page.active {
        display: block;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
        font-size: 24px;
        color: #333;
        margin-bottom: 20px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
    }

    .form-group input,
    .form-group select {
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
    }

    .option-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .option-card {
        background: #f8f9fa;
        border: 3px solid #e0e0e0;
        border-radius: 12px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        position: relative;
    }

    .option-card:hover {
        border-color: #667eea;
        transform: translateY(-3px);
    }

    .option-card.active {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .option-card input[type="radio"],
    .option-card input[type="checkbox"] {
        display: none;
    }

    .card-icon {
        font-size: 32px;
        margin-bottom: 8px;
    }

    .card-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 5px;
    }

    .card-subtitle {
        font-size: 12px;
        color: #666;
    }

    .room-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border-left: 5px solid #667eea;
    }

    .room-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
        cursor: pointer;
    }

    .room-title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
    }

    .delete-room-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }

    .article-form {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-info {
        background: #3b82f6;
        color: white;
    }

    .btn-block {
        width: 100%;
        margin-top: 20px;
    }

    .articles-list {
        margin-top: 20px;
    }

    .article-item {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .article-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .service-item {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 30px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: #10b981;
    }

    input:checked + .toggle-slider:before {
        transform: translateX(30px);
    }

    .recap-card {
        background: #f0f4ff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .recap-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #ddd;
    }

    .recap-row:last-child {
        border-bottom: none;
        font-size: 20px;
        font-weight: bold;
        color: #667eea;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .collapsed-content {
        display: none;
    }

    .collapsed-content.active {
        display: block;
    }

    .checkbox-toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 12px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .checkbox-toggle:hover {
        border-color: #667eea;
    }

    .checkbox-toggle.active {
        border-color: #10b981;
        background: #f0fdf4;
    }

    @media (max-width: 768px) {
        .app-container {
            padding: 10px;
        }

        .nav-menu {
            gap: 5px;
        }

        .nav-item {
            min-width: 80px;
            padding: 10px;
        }

        .option-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
```

</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo">‚ö° DEVTECH</div>
            <a href="app.html" class="back-btn">‚Üê Retour</a>
        </header>

```
    <nav class="nav-menu">
        <button class="nav-item active" data-page="client" onclick="switchPage('client')">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Client</div>
        </button>
        <button class="nav-item" data-page="travaux" onclick="switchPage('travaux')">
            <div class="nav-icon">üî®</div>
            <div class="nav-label">Travaux</div>
        </button>
        <button class="nav-item" data-page="tableau" onclick="switchPage('tableau')">
            <div class="nav-icon">‚ö°</div>
            <div class="nav-label">Tableau</div>
        </button>
        <button class="nav-item" data-page="administratif" onclick="switchPage('administratif')">
            <div class="nav-icon">üìã</div>
            <div class="nav-label">Admin</div>
        </button>
        <button class="nav-item" data-page="recapitulatif" onclick="switchPage('recapitulatif')">
            <div class="nav-icon">üí∞</div>
            <div class="nav-label">R√©cap</div>
        </button>
    </nav>

    <div id="page-client" class="page active">
        <h2 class="section-title">üë§ Informations Client</h2>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Nom complet *</label>
                <input type="text" id="clientName" placeholder="Jean Dupont">
            </div>
            <div class="form-group">
                <label>T√©l√©phone</label>
                <input type="tel" id="clientPhone" placeholder="+32 475 12 34 56">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="clientEmail" placeholder="jean@email.com">
            </div>
            <div class="form-group">
                <label>N¬∞ TVA (optionnel)</label>
                <input type="text" id="clientTVA" placeholder="BE 0123.456.789">
            </div>
            <div class="form-group">
                <label>Rue et num√©ro *</label>
                <input type="text" id="clientRue" placeholder="Rue de la Paix 123">
            </div>
            <div class="form-group">
                <label>Code postal</label>
                <input type="text" id="clientCP" placeholder="1000">
            </div>
            <div class="form-group">
                <label>Commune *</label>
                <input type="text" id="clientCommune" placeholder="Bruxelles">
            </div>
        </div>

        <h3 style="margin: 25px 0 15px; color: #667eea;">üè† Type de projet</h3>
        <div class="option-cards" id="projectTypeCards">
            <label class="option-card active" onclick="event.stopPropagation(); selectProjectType(this)">
                <input type="radio" name="projectType" value="residential" checked>
                <div class="card-icon">üè°</div>
                <div class="card-title">R√©sidentiel</div>
            </label>
            <label class="option-card" onclick="event.stopPropagation(); selectProjectType(this)">
                <input type="radio" name="projectType" value="commercial">
                <div class="card-icon">üè¢</div>
                <div class="card-title">Commercial</div>
            </label>
        </div>

        <h3 style="margin: 25px 0 15px; color: #667eea;">üìÖ √Çge du b√¢timent</h3>
        <div class="option-cards" id="buildingAgeCards">
            <label class="option-card active" onclick="event.stopPropagation(); selectBuildingAge(this)">
                <input type="radio" name="buildingAge" value="old" checked>
                <div class="card-icon">üèöÔ∏è</div>
                <div class="card-title">> 10 ans</div>
                <div class="card-subtitle" style="color: #28a745; font-weight: 700;">TVA 6%</div>
            </label>
            <label class="option-card" onclick="event.stopPropagation(); selectBuildingAge(this)">
                <input type="radio" name="buildingAge" value="new">
                <div class="card-icon">üèóÔ∏è</div>
                <div class="card-title">< 10 ans</div>
                <div class="card-subtitle" style="color: #dc3545; font-weight: 700;">TVA 21%</div>
            </label>
        </div>

        <button class="btn btn-primary btn-block" onclick="switchPage('travaux')">
            Suivant : Travaux ‚Üí
        </button>
    </div>

    <div id="page-travaux" class="page">
        <h2 class="section-title">üî® Configuration des Travaux</h2>
        
        <div style="background: #f0f4ff; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <h3>‚öôÔ∏è Param√®tres globaux</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label><strong>Tarif horaire</strong></label>
                    <select id="globalTarif">
                        <option value="45" selected>Standard - 45‚Ç¨/h</option>
                        <option value="50">Mod√©r√© - 50‚Ç¨/h</option>
                        <option value="65">√âlev√© - 65‚Ç¨/h</option>
                        <option value="75">Urgent - 75‚Ç¨/h</option>
                        <option value="90">Week-end - 90‚Ç¨/h</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><strong>D√©placement</strong></label>
                    <select id="globalDeplacement">
                        <option value="20">20‚Ç¨</option>
                        <option value="25" selected>25‚Ç¨</option>
                        <option value="35">35‚Ç¨</option>
                        <option value="0">Gratuit</option>
                    </select>
                </div>
            </div>
        </div>

        <div style="background: linear-gradient(135deg, #e7f3ff 0%, #d1e7ff 100%); border: 3px solid #667eea; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <h3 style="color: #667eea; margin-bottom: 15px;">üè† Cr√©er une nouvelle pi√®ce</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label><strong>Nom de la pi√®ce</strong></label>
                    <input type="text" id="newRoomName" placeholder="Ex: Salon, Cuisine, Chambre 1...">
                </div>
                <div class="form-group">
                    <button class="btn btn-success" onclick="createRoom()" style="margin-top: 24px; width: 100%;">
                        ‚ûï Cr√©er cette pi√®ce
                    </button>
                </div>
            </div>
        </div>

        <div id="roomsContainer">
            <div class="empty-state">Cr√©ez une pi√®ce pour commencer</div>
        </div>

        <button class="btn btn-primary btn-block" onclick="switchPage('tableau')">
            Suivant : Tableau √©lectrique ‚Üí
        </button>
    </div>

    <div id="page-tableau" class="page">
        <h2 class="section-title">‚ö° Tableau √âlectrique</h2>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Type de coffret</label>
                <select id="coffretType">
                    <option value="">S√©lectionner...</option>
                    <option value="45">Coffret 2R (26 modules) - 45‚Ç¨</option>
                    <option value="55">Coffret 3R (39 modules) - 55‚Ç¨</option>
                    <option value="65">Coffret 4R (52 modules) - 65‚Ç¨</option>
                </select>
            </div>
            <div class="form-group">
                <label>Diff√©rentiel 40A Type AC (35‚Ç¨)</label>
                <input type="number" id="diffAC" value="1" min="0">
            </div>
            <div class="form-group">
                <label>Diff√©rentiel 40A Type A (45‚Ç¨)</label>
                <input type="number" id="diffA" value="1" min="0">
            </div>
            <div class="form-group">
                <label>Parafoudre (120‚Ç¨)</label>
                <select id="parafoudre">
                    <option value="non">Non</option>
                    <option value="oui">Oui</option>
                </select>
            </div>
            <div class="form-group">
                <label>Contacteur jour/nuit (28‚Ç¨)</label>
                <input type="number" id="contacteur" value="0" min="0">
            </div>
        </div>

        <button class="btn btn-primary btn-block" onclick="switchPage('administratif')">
            Suivant : Services administratifs ‚Üí
        </button>
    </div>

    <div id="page-administratif" class="page">
        <h2 class="section-title">üìã Services Administratifs</h2>
        
        <div class="service-item">
            <div>
                <div style="font-weight: bold; font-size: 16px;">Mise en conformit√©</div>
                <div style="color: #667eea; font-size: 18px; font-weight: bold;">450‚Ç¨</div>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="service-conformite">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="service-item">
            <div>
                <div style="font-weight: bold; font-size: 16px;">Diagnostic √©lectrique</div>
                <div style="color: #667eea; font-size: 18px; font-weight: bold;">180‚Ç¨</div>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="service-diagnostic">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="service-item">
            <div>
                <div style="font-weight: bold; font-size: 16px;">Certificat de conformit√©</div>
                <div style="color: #667eea; font-size: 18px; font-weight: bold;">80‚Ç¨</div>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="service-certificat">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="service-item">
            <div>
                <div style="font-weight: bold; font-size: 16px;">Sch√©ma √©lectrique</div>
                <div style="color: #667eea; font-size: 18px; font-weight: bold;">120‚Ç¨</div>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="service-schema">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <button class="btn btn-primary btn-block" onclick="switchPage('recapitulatif')">
            Suivant : R√©capitulatif ‚Üí
        </button>
    </div>

    <div id="page-recapitulatif" class="page">
        <h2 class="section-title">üí∞ R√©capitulatif du Devis</h2>
        
        <div id="recapContent"></div>

        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 3px solid #ffc107; padding: 20px; border-radius: 12px; margin: 20px 0;">
            <h3 style="color: #856404; margin-bottom: 15px;">üí∞ Ristourne (optionnel)</h3>
            
            <label class="checkbox-toggle" onclick="toggleRistourne()" id="ristourneToggle">
                <input type="checkbox" id="ristourneEnabled">
                <span style="font-weight: bold;">Appliquer une ristourne</span>
            </label>

            <div id="ristourneOptions" style="display: none; margin-top: 15px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Pourcentage (%)</label>
                        <input type="number" id="ristournePourcent" value="15" min="0" max="100" onchange="calculateRecap()">
                    </div>
                    <div class="form-group">
                        <label>Validit√© (jours)</label>
                        <input type="number" id="ristourneDelai" value="30" min="1">
                    </div>
                </div>
                <div style="background: #d1ecf1; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px; color: #0c5460;">
                    ‚ÑπÔ∏è La ristourne sera calcul√©e sur le <strong>montant HT</strong> du devis (avant TVA). Le client verra l'√©conomie totale TTC.
                </div>
            </div>
        </div>

        <div class="recap-card">
            <div class="recap-row">
                <span>Total mat√©riel HT :</span>
                <span id="totalMaterielHT">0.00 ‚Ç¨</span>
            </div>
            <div class="recap-row">
                <span>Total main d'≈ìuvre HT :</span>
                <span id="totalMOHT">0.00 ‚Ç¨</span>
            </div>
            <div class="recap-row">
                <span>Services administratifs :</span>
                <span id="totalServicesHT">0.00 ‚Ç¨</span>
            </div>
            <div class="recap-row">
                <span>D√©placement :</span>
                <span id="totalDeplacement">25.00 ‚Ç¨</span>
            </div>
            <div class="recap-row" style="border-top: 2px solid #667eea; padding-top: 10px; margin-top: 5px;">
                <span><strong>Sous-total HT :</strong></span>
                <span id="sousTotalHT"><strong>0.00 ‚Ç¨</strong></span>
            </div>
            <div class="recap-row" id="ristourneRow" style="display: none; color: #28a745;">
                <span>Ristourne (-<span id="ristournePercentDisplay">15</span>%) :</span>
                <span id="montantRistourne">-0.00 ‚Ç¨</span>
            </div>
            <div class="recap-row">
                <span>TVA (<span id="tvaPercent">6</span>%) :</span>
                <span id="montantTVA">0.00 ‚Ç¨</span>
            </div>
            <div class="recap-row" style="font-size: 22px;">
                <span>TOTAL TTC :</span>
                <span id="totalTTC">0.00 ‚Ç¨</span>
            </div>
        </div>

        <div style="display: flex; gap: 15px;">
            <button class="btn btn-primary btn-block" onclick="generatePDF()">
                üìÑ G√©n√©rer PDF
            </button>
            <button class="btn btn-success btn-block" onclick="saveDevis()">
                üíæ Enregistrer
            </button>
        </div>
    </div>
</div>
```

<script type="module">

    ```
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyAQ9YFHCYhKG-65rqJp31QEb68F9oY4HFk",
    authDomain: "devtech-20997.firebaseapp.com",
    projectId: "devtech-20997",
    storageBucket: "devtech-20997.firebasestorage.app",
    messagingSenderId: "95961701207",
    appId: "1:95961701207:web:25ac1e97f292c58797bc12"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let catalogueProduits = [];

const devisState = {
    client: {},
    global: { tarif: 45, tva: 0.06, deplacement: 25 },
    rooms: [],
    nextRoomId: 1
};

const FACTEURS = {
    installation: {
        'apparent': 1.0,
        'faux-plafond': 1.2,
        'encastre': 1.3,
        'encastre-lourd': 1.45
    },
    circuit: {
        'existant': 1.0,
        'nouvelle-ligne': 1.2
    },
    longueur: {
        ranges: [
            { max: 5, factor: 1.0 },
            { max: 10, factor: 1.1 },
            { max: 20, factor: 1.2 },
            { max: 30, factor: 1.3 },
            { max: 50, factor: 1.45 },
            { max: Infinity, factor: 1.6 }
        ]
    }
};

const MARGES_CATEGORIE = {
    'appareillage': 0.35,
    'consommables': 0.40,
    'cables': 0.25,
    'protections': 0.25,
    'goulottes': 0.25,
    'gros-materiel': 0.18
};

const CABLE_TEMPS = {
    '3G1.5': 1.0,
    '3G2.5': 1.0,
    '5G6': 1.5,
    'HDMI': 1.3,
    'RJ45': 1.3,
    'default': 1.2
};

const CABLE_PRIX = {
    '3G1.5': 1.20,
    '3G2.5': 1.80,
    '5G6': 3.50,
    '3G4': 2.50,
    'HDMI': 2.00,
    'RJ45': 1.50
};

const SETUP_TIRAGE = 15;

function getLengthFactor(meters) {
    for (const range of FACTEURS.longueur.ranges) {
        if (meters <= range.max) return range.factor;
    }
    return 1.6;
}

function roundTo15Minutes(minutes) {
    return Math.ceil(minutes / 15) * 15;
}

function applyMinimumBillable(minutes) {
    return Math.max(minutes, 60);
}

function calculateSalePrice(purchasePrice, category) {
    const margin = MARGES_CATEGORIE[category] || 0.25;
    return purchasePrice * (1 + margin);
}

function calculateInterventionTime(tempsBase, cables, coeffInstallation, coeffCircuit) {
    let tempsTotal = tempsBase;
    let tempsCablage = 0;
    
    if (cables && cables.length > 0) {
        tempsCablage += SETUP_TIRAGE;
        cables.forEach(cable => {
            const minutesPerMeter = CABLE_TEMPS[cable.type] || CABLE_TEMPS['default'];
            const lengthFactor = getLengthFactor(cable.length);
            tempsCablage += cable.length * minutesPerMeter * lengthFactor;
        });
    }
    
    tempsTotal = (tempsBase + tempsCablage) * coeffInstallation * coeffCircuit;
    tempsTotal = roundTo15Minutes(tempsTotal);
    
    return tempsTotal;
}

onAuthStateChanged(auth, async (user) => {
    if (!user || !user.emailVerified) {
        window.location.href = 'login.html';
    } else {
        currentUser = user;
        await loadCatalogue();
        await loadEditDevis();
    }
});

async function loadEditDevis() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('action') === 'generatePDF') {
        const pdfData = localStorage.getItem('generatePDFFromDevis');
        if (pdfData) {
            const devisData = JSON.parse(pdfData);
            localStorage.removeItem('generatePDFFromDevis');
            await loadDevisData(devisData);
            setTimeout(() => {
                generatePDF();
                setTimeout(() => {
                    window.location.href = 'mes-devis.html';
                }, 1000);
            }, 500);
            return;
        }
    }
    
    const editDevisId = localStorage.getItem('editDevisId');
    if (!editDevisId) return;
    
    try {
        const devisDoc = await getDoc(doc(db, 'devis', editDevisId));
        if (!devisDoc.exists()) {
            localStorage.removeItem('editDevisId');
            return;
        }
        const devisData = devisDoc.data();
        await loadDevisData(devisData);
        localStorage.removeItem('editDevisId');
        alert('‚úÖ Devis charg√© ! Vous pouvez le modifier.');
    } catch (error) {
        console.error('Erreur chargement devis:', error);
        localStorage.removeItem('editDevisId');
    }
}

async function loadDevisData(devisData) {
    document.getElementById('clientName').value = devisData.client?.nom || '';
    document.getElementById('clientPhone').value = devisData.client?.telephone || '';
    document.getElementById('clientEmail').value = devisData.client?.email || '';
    document.getElementById('clientTVA').value = devisData.client?.tva || '';
    
    const adresseParts = (devisData.client?.adresse || '').split(',');
    document.getElementById('clientRue').value = adresseParts[0]?.trim() || '';
    if (adresseParts[1]) {
        const cpVille = adresseParts[1].trim().split(' ');
        document.getElementById('clientCP').value = cpVille[0] || '';
        document.getElementById('clientCommune').value = cpVille.slice(1).join(' ') || '';
    }
    
    const projectType = devisData.batiment?.type || 'residential';
    const buildingAge = devisData.batiment?.age || 'old';
    
    document.querySelectorAll('input[name="projectType"]').forEach(input => {
        const card = input.closest('.option-card');
        if (input.value === projectType) {
            input.checked = true;
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    document.querySelectorAll('input[name="buildingAge"]').forEach(input => {
        const card = input.closest('.option-card');
        if (input.value === buildingAge) {
            input.checked = true;
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    devisState.rooms = devisData.rooms || [];
    devisState.nextRoomId = Math.max(...devisState.rooms.map(r => r.id), 0) + 1;
    
    if (devisData.ristourne) {
        document.getElementById('ristourneEnabled').checked = devisData.ristourne.enabled;
        document.getElementById('ristournePourcent').value = devisData.ristourne.pourcent || 15;
        document.getElementById('ristourneDelai').value = devisData.ristourne.delai || 30;
        if (devisData.ristourne.enabled) toggleRistourne();
    }
    
    renderRooms();
    updateRecap();
}

async function loadCatalogue() {
    try {
        const snapshot = await getDocs(collection(db, 'products'));
        catalogueProduits = snapshot.docs.map(doc => {
            const data = doc.data();
            if (!data.category) {
                const name = (data.name || '').toLowerCase();
                if (name.includes('prise') || name.includes('interrupteur')) data.category = 'appareillage';
                else if (name.includes('cable')) data.category = 'cables';
                else if (name.includes('disjoncteur') || name.includes('differentiel')) data.category = 'protections';
                else data.category = 'appareillage';
            }
            if (!data.tempsBase) {
                const name = (data.name || '').toLowerCase();
                if (name.includes('va-et-vient')) data.tempsBase = 75;
                else if (name.includes('prise') && name.includes('encastr')) data.tempsBase = 35;
                else if (name.includes('prise')) data.tempsBase = 25;
                else if (name.includes('interrupteur')) data.tempsBase = 20;
                else data.tempsBase = 30;
            }
            return { id: doc.id, ...data };
        });
        console.log('‚úÖ Catalogue charg√©:', catalogueProduits.length, 'produits');
    } catch (error) {
        console.error('‚ùå Erreur:', error);
    }
}

window.switchPage = function(pageName) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-' + pageName).classList.add('active');
    document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
    if (pageName === 'recapitulatif') calculateRecap();
}

window.selectProjectType = function(card) {
    const parent = document.getElementById('projectTypeCards');
    parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    card.querySelector('input').checked = true;
}

window.selectBuildingAge = function(card) {
    const parent = document.getElementById('buildingAgeCards');
    parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    card.querySelector('input').checked = true;
}

window.createRoom = function() {
    const roomName = document.getElementById('newRoomName').value.trim();
    if (!roomName) { alert('Nom de pi√®ce requis'); return; }
    
    devisState.rooms.push({
        id: devisState.nextRoomId++,
        name: roomName,
        articles: [],
        cabling: { cables: [] },
        coefficients: { installation: 'encastre', circuit: 'nouvelle-ligne' },
        collapsed: false
    });
    
    document.getElementById('newRoomName').value = '';
    renderRooms();
}

function renderRooms() {
    const container = document.getElementById('roomsContainer');
    if (devisState.rooms.length === 0) {
        container.innerHTML = '<div class="empty-state">Cr√©ez une pi√®ce pour commencer</div>';
        return;
    }

    container.innerHTML = devisState.rooms.map(room => {
        const arrow = room.collapsed ? '‚ñ∂' : '‚ñº';
        return `
            <div class="room-card">
                <div class="room-header" onclick="toggleRoom(${room.id})">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>${arrow}</span>
                        <div class="room-title">üìç ${room.name}</div>
                    </div>
                    <button class="delete-room-btn" onclick="event.stopPropagation(); deleteRoom(${room.id})">üóëÔ∏è</button>
                </div>

                <div class="collapsed-content ${room.collapsed ? '' : 'active'}">
                    <div class="article-form">
                        <h4>‚ûï Ajouter un article</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Cat√©gorie</label>
                                <select id="category-${room.id}" onchange="filterProducts(${room.id})">
                                    <option value="">-- S√©lectionner --</option>
                                    <option value="eclairage">üí° √âclairage</option>
                                    <option value="prises">üîå Prises</option>
                                    <option value="interrupteurs">üéõÔ∏è Interrupteurs</option>
                                    <option value="protections">üõ°Ô∏è Protections</option>
                                    <option value="cables">üîó C√¢bles</option>
                                    <option value="consommables">üî© Consommables</option>
                                    <option value="autres">üì¶ Autres</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Article</label>
                                <select id="article-${room.id}" disabled>
                                    <option value="">-- Choisir cat√©gorie d'abord --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantit√©</label>
                                <input type="number" id="qty-${room.id}" value="1" min="1">
                            </div>
                        </div>

                        <h4 style="margin: 15px 0 10px;">üîß Type d'installation</h4>
                        <div class="option-cards" id="install-cards-${room.id}">
                            <label class="option-card" onclick="selectInstall(${room.id}, 'apparent', event)">
                                <input type="radio" name="install-${room.id}" value="apparent">
                                <div class="card-icon">üì¶</div>
                                <div class="card-title">Apparent</div>
                                <div class="card-subtitle">√ó1.0</div>
                            </label>
                            <label class="option-card active" onclick="selectInstall(${room.id}, 'encastre', event)">
                                <input type="radio" name="install-${room.id}" value="encastre" checked>
                                <div class="card-icon">üî®</div>
                                <div class="card-title">Encastr√©</div>
                                <div class="card-subtitle">√ó1.3</div>
                            </label>
                            <label class="option-card" onclick="selectInstall(${room.id}, 'faux-plafond', event)">
                                <input type="radio" name="install-${room.id}" value="faux-plafond">
                                <div class="card-icon">‚¨ÜÔ∏è</div>
                                <div class="card-title">Faux plafond</div>
                                <div class="card-subtitle">√ó1.2</div>
                            </label>
                            <label class="option-card" onclick="selectInstall(${room.id}, 'encastre-lourd', event)">
                                <input type="radio" name="install-${room.id}" value="encastre-lourd">
                                <div class="card-icon">‚öíÔ∏è</div>
                                <div class="card-title">Encastr√© lourd</div>
                                <div class="card-subtitle">√ó1.45</div>
                            </label>
                        </div>

                        <h4 style="margin: 15px 0 10px;">‚ö° Type de circuit</h4>
                        <div class="option-cards" id="circuit-cards-${room.id}">
                            <label class="option-card" onclick="selectCircuit(${room.id}, 'existant', event)">
                                <input type="radio" name="circuit-${room.id}" value="existant">
                                <div class="card-icon">üîÑ</div>
                                <div class="card-title">Existant</div>
                                <div class="card-subtitle">√ó1.0</div>
                            </label>
                            <label class="option-card active" onclick="selectCircuit(${room.id}, 'nouvelle-ligne', event)">
                                <input type="radio" name="circuit-${room.id}" value="nouvelle-ligne" checked>
                                <div class="card-icon">‚ö°</div>
                                <div class="card-title">Nouvelle ligne</div>
                                <div class="card-subtitle">√ó1.2</div>
                            </label>
                        </div>

                        <h4 style="margin: 15px 0 10px;">üèóÔ∏è Rebouchage</h4>
                        <label class="checkbox-toggle" onclick="toggleRebouchage(${room.id}, event)" id="rebouchage-toggle-${room.id}">
                            <input type="checkbox" id="rebouchage-${room.id}">
                            <span>Rebouchage et finition</span>
                            <input type="number" id="rebouchage-price-${room.id}" value="20" onclick="event.stopPropagation()" style="width: 80px; padding: 5px; margin-left: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                            <span>‚Ç¨</span>
                        </label>

                        <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid #0ea5e9;">
                            <h4 style="margin: 0 0 10px 0;">üîó C√¢blage intervention</h4>
                            <div style="margin-bottom: 10px;">
                                ${(room.cabling.cables || []).map((cable, idx) => `
                                    <div style="background: white; padding: 8px; border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
                                        <div><strong>${cable.type}</strong> - ${cable.length}m @ ${cable.pricePerMeter.toFixed(2)}‚Ç¨/m</div>
                                        <button onclick="deleteCable(${room.id}, ${idx})" style="background: #ef4444; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">üóëÔ∏è</button>
                                    </div>
                                `).join('') || '<div style="text-align: center; padding: 8px; color: #64748b; font-size: 12px;">Aucun c√¢ble</div>'}
                            </div>
                            <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 8px; align-items: end;">
                                <select id="cable-type-${room.id}" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 13px;">
                                    <option value="">Type c√¢ble</option>
                                    <option value="3G1.5">3G1.5 (1.20‚Ç¨/m)</option>
                                    <option value="3G2.5">3G2.5 (1.80‚Ç¨/m)</option>
                                    <option value="5G6">5G6 (3.50‚Ç¨/m)</option>
                                    <option value="3G4">3G4 (2.50‚Ç¨/m)</option>
                                    <option value="HDMI">HDMI (2.00‚Ç¨/m)</option>
                                    <option value="RJ45">RJ45 (1.50‚Ç¨/m)</option>
                                </select>
                                <input type="number" id="cable-length-${room.id}" value="10" min="1" step="0.5" placeholder="M√®tres" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 13px;">
                                <button onclick="addCable(${room.id})" style="background: #0ea5e9; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; white-space: nowrap;">+ C√¢ble</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-info" onclick="calculateArticle(${room.id})" style="flex: 1;">üßÆ Calculer</button>
                            <button class="btn btn-success" onclick="addArticle(${room.id})" style="flex: 1;">‚ûï Ajouter</button>
                        </div>

                        <div id="preview-${room.id}" style="display: none; background: #e7f3ff; padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <h4>üìä Aper√ßu</h4>
                            <div id="preview-content-${room.id}"></div>
                        </div>
                    </div>

                    <div class="articles-list">
                        ${room.articles.map((art, idx) => `
                            <div class="article-item">
                                <div class="article-header">
                                    <strong>${art.qty}x ${art.name}</strong>
                                    <button onclick="deleteArticle(${room.id}, ${idx})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">üóëÔ∏è</button>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                    <div>Mat√©riel:</div><div style="text-align: right;">${art.materiel.toFixed(2)}‚Ç¨</div>
                                    <div>Main d'≈ìuvre:</div><div style="text-align: right;">${art.mo.toFixed(2)}‚Ç¨</div>
                                    ${art.rebouchage > 0 ? `<div>Rebouchage:</div><div style="text-align: right;">${art.rebouchage.toFixed(2)}‚Ç¨</div>` : ''}
                                    <div style="border-top: 2px solid #667eea; padding-top: 5px;"><strong>Total:</strong></div>
                                    <div style="border-top: 2px solid #667eea; padding-top: 5px; text-align: right;"><strong>${art.total.toFixed(2)}‚Ç¨</strong></div>
                                </div>
                            </div>
                        `).join('') || '<div style="text-align: center; padding: 20px; color: #999;">Aucun article</div>'}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

window.filterProducts = function(roomId) {
    const categorySelect = document.getElementById(`category-${roomId}`);
    const articleSelect = document.getElementById(`article-${roomId}`);
    const category = categorySelect.value;

    if (!category) {
        articleSelect.disabled = true;
        articleSelect.innerHTML = '<option value="">-- Choisir cat√©gorie d\'abord --</option>';
        return;
    }

    let filtered = catalogueProduits.filter(p => {
        const name = (p.name || '').toLowerCase();
        const cat = p.category || 'appareillage';
        if (category === 'eclairage') return name.includes('led') || name.includes('spot') || name.includes('luminaire');
        else if (category === 'prises') return name.includes('prise') && !name.includes('interrupteur');
        else if (category === 'interrupteurs') return name.includes('interrupteur') || name.includes('va-et-vient');
        else if (category === 'consommables') return name.includes('cheville') || name.includes('wago') || cat === 'consommables';
        else return cat === category;
    });

    if (filtered.length === 0) {
        articleSelect.innerHTML = '<option value="">Aucun produit</option>';
        articleSelect.disabled = true;
    } else {
        articleSelect.disabled = false;
        let html = '<option value="">-- S√©lectionner --</option>';
        filtered.forEach(p => {
            const marge = MARGES_CATEGORIE[p.category] || 0.25;
            const prixVente = (p.price * (1 + marge)).toFixed(2);
            html += `<option value="${p.ref}">${p.name} - ${p.price.toFixed(2)}‚Ç¨ ‚Üí ${prixVente}‚Ç¨</option>`;
        });
        articleSelect.innerHTML = html;
    }
}

window.selectInstall = function(roomId, type, e) {
    e.stopPropagation();
    const parent = document.getElementById(`install-cards-${roomId}`);
    parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const room = devisState.rooms.find(r => r.id === roomId);
    if (room) room.coefficients.installation = type;
}

window.selectCircuit = function(roomId, type, e) {
    e.stopPropagation();
    const parent = document.getElementById(`circuit-cards-${roomId}`);
    parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const room = devisState.rooms.find(r => r.id === roomId);
    if (room) room.coefficients.circuit = type;
}

window.toggleRebouchage = function(roomId, e) {
    if (e) e.stopPropagation();
    const toggle = document.getElementById(`rebouchage-toggle-${roomId}`);
    const checkbox = document.getElementById(`rebouchage-${roomId}`);
    checkbox.checked = !checkbox.checked;
    toggle.classList.toggle('active', checkbox.checked);
}

window.toggleRoom = function(roomId) {
    const room = devisState.rooms.find(r => r.id === roomId);
    if (room) {
        room.collapsed = !room.collapsed;
        renderRooms();
    }
}

window.calculateArticle = function(roomId) {
    const ref = document.getElementById(`article-${roomId}`).value;
    if (!ref) { alert('S√©lectionnez un article'); return; }
    const product = catalogueProduits.find(p => p.ref === ref);
    if (!product) return;

    const room = devisState.rooms.find(r => r.id === roomId);
    const qty = parseInt(document.getElementById(`qty-${roomId}`).value) || 1;
    const installType = document.querySelector(`input[name="install-${room.id}"]:checked`).value;
    const circuitType = document.querySelector(`input[name="circuit-${room.id}"]:checked`).value;
    const rebouchage = document.getElementById(`rebouchage-${room.id}`).checked;
    const rebouchagePrice = parseFloat(document.getElementById(`rebouchage-price-${room.id}`).value) || 20;
    const tarif = parseFloat(document.getElementById('globalTarif').value);
    
    const category = product.category || 'appareillage';
    const tempsBase = product.tempsBase || 30;
    const prixVente = calculateSalePrice(product.price, category);
    const materielTotal = prixVente * qty;
    
    const coeffInstall = FACTEURS.installation[installType];
    const coeffCircuit = FACTEURS.circuit[circuitType];
    const tempsIntervention = calculateInterventionTime(tempsBase, room.cabling.cables || [], coeffInstall, coeffCircuit);
    const mo = (tempsIntervention / 60) * tarif;
    const total = materielTotal + mo + (rebouchage ? rebouchagePrice : 0);

    document.getElementById(`preview-${room.id}`).style.display = 'block';
    document.getElementById(`preview-content-${room.id}`).innerHTML = `
        <div><strong>${qty}x ${product.name}</strong></div>
        <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 14px;">
            <div>Mat√©riel:</div><div style="text-align: right;">${materielTotal.toFixed(2)}‚Ç¨</div>
            <div>MO:</div><div style="text-align: right;">${mo.toFixed(2)}‚Ç¨ (${tempsIntervention}min)</div>
            ${rebouchage ? `<div>Rebouchage:</div><div style="text-align: right;">${rebouchagePrice.toFixed(2)}‚Ç¨</div>` : ''}
            <div style="border-top: 2px solid #667eea; padding-top: 5px;"><strong>Total:</strong></div>
            <div style="border-top: 2px solid #667eea; padding-top: 5px; text-align: right;"><strong>${total.toFixed(2)}‚Ç¨</strong></div>
        </div>
    `;
}

window.addArticle = function(roomId) {
    const room = devisState.rooms.find(r => r.id === roomId);
    if (!room) return;
    const ref = document.getElementById(`article-${roomId}`).value;
    if (!ref) { alert('S√©lectionnez un article'); return; }
    const product = catalogueProduits.find(p => p.ref === ref);
    if (!product) return;

    const qty = parseInt(document.getElementById(`qty-${roomId}`).value) || 1;
    const rebouchage = document.getElementById(`rebouchage-${roomId}`).checked;
    const rebouchagePrice = parseFloat(document.getElementById(`rebouchage-price-${roomId}`).value) || 20;
    const installType = document.querySelector(`input[name="install-${roomId}"]:checked`).value;
    const circuitType = document.querySelector(`input[name="circuit-${roomId}"]:checked`).value;
    
    room.coefficients.installation = installType;
    room.coefficients.circuit = circuitType;
    
    const category = product.category || 'appareillage';
    const tempsBase = product.tempsBase || 30;
    const prixVente = calculateSalePrice(product.price, category);
    const materielTotal = prixVente * qty;
    const tarif = parseFloat(document.getElementById('globalTarif').value);
    const coeffInstall = FACTEURS.installation[installType];
    const coeffCircuit = FACTEURS.circuit[circuitType];
    const tempsIntervention = calculateInterventionTime(tempsBase, room.cabling.cables || [], coeffInstall, coeffCircuit);
    const mo = (tempsIntervention / 60) * tarif;
    const total = materielTotal + mo + (rebouchage ? rebouchagePrice : 0);
    
    room.articles.push({
        ref: product.ref,
        name: product.name,
        qty: qty,
        prixAchat: product.price,
        category: category,
        tempsBase: tempsBase,
        materiel: materielTotal,
        mo: mo,
        rebouchage: rebouchage ? rebouchagePrice : 0,
        total: total
    });

    renderRooms();
    calculateRecap();
}

window.deleteArticle = function(roomId, idx) {
    const room = devisState.rooms.find(r => r.id === roomId);
    if (room && confirm('Supprimer ?')) {
        room.articles.splice(idx, 1);
        renderRooms();
        calculateRecap();
    }
}

window.addCable = function(roomId) {
    const room = devisState.rooms.find(r => r.id === roomId);
    if (!room) return;
    const type = document.getElementById(`cable-type-${roomId}`).value;
    const length = parseFloat(document.getElementById(`cable-length-${roomId}`).value);
    if (!type || !length || length <= 0) { alert('Donn√©es invalides'); return; }

    room.cabling.cables.push({
        type: type,
        length: length,
        pricePerMeter: CABLE_PRIX[type] || 1.50,
        category: 'cables'
    });

    document.getElementById(`cable-type-${roomId}`).value = '';
    document.getElementById(`cable-length-${roomId}`).value = '10';
    renderRooms();
    calculateRecap();
}

window.deleteCable = function(roomId, idx) {
    const room = devisState.rooms.find(r => r.id === roomId);
    if (room && confirm('Supprimer ce c√¢ble ?')) {
        room.cabling.cables.splice(idx, 1);
        renderRooms();
        calculateRecap();
    }
}

window.deleteRoom = function(roomId) {
    if (confirm('Supprimer cette pi√®ce ?')) {
        devisState.rooms = devisState.rooms.filter(r => r.id !== roomId);
        renderRooms();
        calculateRecap();
    }
}

window.toggleRistourne = function() {
    const enabled = document.getElementById('ristourneEnabled').checked;
    const toggle = document.getElementById('ristourneToggle');
    toggle.classList.toggle('active', enabled);
    document.getElementById('ristourneOptions').style.display = enabled ? 'block' : 'none';
    calculateRecap();
}

function calculateRecap() {
    const tarif = parseFloat(document.getElementById('globalTarif').value) || 45;
    const deplacement = parseFloat(document.getElementById('globalDeplacement').value) || 25;
    const buildingAge = document.querySelector('input[name="buildingAge"]:checked').value;
    const tva = buildingAge === 'old' ? 0.06 : 0.21;

    let totalMateriel = 0;
    let totalMO = 0;
    let totalMinutes = 0;

    devisState.rooms.forEach(room => {
        const coeffInstall = FACTEURS.installation[room.coefficients?.installation || 'encastre'];
        const coeffCircuit = FACTEURS.circuit[room.coefficients?.circuit || 'nouvelle-ligne'];
        
        room.articles.forEach(art => {
            const tempsBase = art.tempsBase || 30;
            const tempsIntervention = calculateInterventionTime(tempsBase, room.cabling.cables || [], coeffInstall, coeffCircuit);
            totalMinutes += tempsIntervention;
            const category = art.category || 'appareillage';
            const prixVente = calculateSalePrice(art.prixAchat, category);
            totalMateriel += prixVente * art.qty + (art.rebouchage || 0);
            const mo = (tempsIntervention / 60) * tarif;
            totalMO += mo;
        });
        
        (room.cabling.cables || []).forEach(cable => {
            const coutCable = cable.length * cable.pricePerMeter;
            const coutAvecMarge = calculateSalePrice(coutCable, 'cables');
            totalMateriel += coutAvecMarge;
        });
    });

    totalMinutes = applyMinimumBillable(totalMinutes);
    if (totalMinutes === 60 && totalMO < tarif) totalMO = tarif;

    const coffret = parseFloat(document.getElementById('coffretType').value) || 0;
    const diffAC = parseInt(document.getElementById('diffAC').value) || 0;
    const diffA = parseInt(document.getElementById('diffA').value) || 0;
    const parafoudre = document.getElementById('parafoudre').value === 'oui' ? 120 : 0;
    const contacteur = (parseInt(document.getElementById('contacteur').value) || 0) * 28;
    totalMateriel += coffret + (diffAC * 35) + (diffA * 45) + parafoudre + contacteur;

    let totalServices = 0;
    if (document.getElementById('service-conformite').checked) totalServices += 450;
    if (document.getElementById('service-diagnostic').checked) totalServices += 180;
    if (document.getElementById('service-certificat').checked) totalServices += 80;
    if (document.getElementById('service-schema').checked) totalServices += 120;

    let sousTotalHT = totalMateriel + totalMO + totalServices + deplacement;
    let montantRistourne = 0;
    let pourcent = 0;
    
    if (document.getElementById('ristourneEnabled').checked) {
        pourcent = parseFloat(document.getElementById('ristournePourcent').value) || 15;
        montantRistourne = sousTotalHT * (pourcent / 100);
        document.getElementById('ristourneRow').style.display = 'flex';
        document.getElementById('ristournePercentDisplay').textContent = pourcent;
        document.getElementById('montantRistourne').textContent = '-' + montantRistourne.toFixed(2) + ' ‚Ç¨';
    } else {
        document.getElementById('ristourneRow').style.display = 'none';
    }

    const sousTotalApresRistourne = sousTotalHT - montantRistourne;
    const montantTVA = sousTotalApresRistourne * tva;
    const totalTTC = sousTotalApresRistourne + montantTVA;

    document.getElementById('totalMaterielHT').textContent = totalMateriel.toFixed(2) + ' ‚Ç¨';
    document.getElementById('totalMOHT').textContent = totalMO.toFixed(2) + ' ‚Ç¨';
    document.getElementById('totalServicesHT').textContent = totalServices.toFixed(2) + ' ‚Ç¨';
    document.getElementById('totalDeplacement').textContent = deplacement.toFixed(2) + ' ‚Ç¨';
    document.getElementById('sousTotalHT').textContent = sousTotalHT.toFixed(2) + ' ‚Ç¨';
    document.getElementById('tvaPercent').textContent = (tva * 100).toFixed(0);
    document.getElementById('montantTVA').textContent = montantTVA.toFixed(2) + ' ‚Ç¨';
    document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';

    document.getElementById('recapContent').innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3>üë§ Client</h3>
            <p><strong>${document.getElementById('clientName').value || 'Non renseign√©'}</strong></p>
            <p>${document.getElementById('clientRue').value}, ${document.getElementById('clientCP').value} ${document.getElementById('clientCommune').value}</p>
            <p><em>Temps total: ${Math.round(totalMinutes)} minutes (${(totalMinutes/60).toFixed(1)}h)</em></p>
        </div>
        <div style="background: white; padding: 20px; border-radius: 10px;">
            <h3>üìç Pi√®ces (${devisState.rooms.length})</h3>
            ${devisState.rooms.map(room => `<p><strong>${room.name}</strong> - ${room.articles.length} articles</p>`).join('')}
        </div>
    `;
}

window.updateRecap = calculateRecap;

window.generatePDF = async function() {
    const { jsPDF } = window.jspdf;
    let companyInfo = { nom: 'NOORELEC', slogan: "L'ART DU SAVOIR-FAIRE", iban: 'BE12 3456 7890 1234', titulaire: 'Noorelec SA', ville: 'Bruxelles' };
    try {
        const settingsDoc = await getDoc(doc(db, 'settings', currentUser.uid));
        if (settingsDoc.exists() && settingsDoc.data().company) companyInfo = { ...companyInfo, ...settingsDoc.data().company };
    } catch (e) {}
    
    const pdf = new jsPDF();
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    
    pdf.setFontSize(28);
    pdf.setTextColor(0, 128, 96);
    pdf.setFont(undefined, 'bold');
    pdf.text(companyInfo.nom, 20, 25);
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'normal');
    pdf.text(companyInfo.slogan, 20, 32);
    pdf.setTextColor(0, 0, 0);
    const today = new Date().toLocaleDateString('fr-FR');
    pdf.text('Fait le ' + today, pageWidth - 20, 20, { align: 'right' });
    pdf.text('√† ' + companyInfo.ville, pageWidth - 20, 26, { align: 'right' });
    
    let y = 45;
    pdf.setFontSize(11);
    pdf.setFont(undefined, 'bold');
    pdf.text('CLIENT:', 20, y);
    pdf.setFont(undefined, 'normal');
    pdf.setFontSize(10);
    y += 6;
    pdf.text(document.getElementById('clientName').value || 'Non renseign√©', 20, y);
    const clientTVA = document.getElementById('clientTVA').value;
    if (clientTVA) { y += 5; pdf.text('TVA: ' + clientTVA, 20, y); }
    y += 5;
    pdf.text(document.getElementById('clientRue').value || '', 20, y);
    y += 5;
    pdf.text((document.getElementById('clientCP').value || '') + ' ' + (document.getElementById('clientCommune').value || ''), 20, y);
    
    y += 10;
    pdf.setFontSize(14);
    pdf.setFont(undefined, 'bold');
    pdf.setTextColor(25, 55, 109);
    pdf.text('DEVIS - TRAVAUX √âLECTRIQUES', pageWidth / 2, y, { align: 'center' });
    y += 12;
    
    pdf.setFillColor(25, 55, 109);
    pdf.rect(20, y, pageWidth - 40, 8, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(11);
    pdf.text('TRAVAUX', 22, y + 5.5);
    y += 10;
    pdf.setTextColor(0, 0, 0);
    pdf.setFontSize(9);
    
    devisState.rooms.forEach(room => {
        if (y > pageHeight - 30) { pdf.addPage(); y = 20; }
        pdf.setFillColor(220, 230, 255);
        pdf.rect(22, y - 3, pageWidth - 44, 7, 'F');
        pdf.setFont(undefined, 'bold');
        pdf.text(room.name, 24, y + 2);
        y += 8;
        pdf.setFont(undefined, 'normal');
        
        room.articles.forEach(art => {
            if (y > pageHeight - 30) { pdf.addPage(); y = 20; }
            pdf.text(`  ${art.qty}x ${art.name}`, 26, y);
            pdf.text(art.total.toFixed(2) + '‚Ç¨', pageWidth - 22, y, { align: 'right' });
            y += 5;
        });
        
        (room.cabling.cables || []).forEach(cable => {
            if (y > pageHeight - 30) { pdf.addPage(); y = 20; }
            pdf.text(`  C√¢ble ${cable.type} (${cable.length}m)`, 26, y);
            const cout = calculateSalePrice(cable.length * cable.pricePerMeter, 'cables');
            pdf.text(cout.toFixed(2) + '‚Ç¨', pageWidth - 22, y, { align: 'right' });
            y += 5;
        });
        y += 4;
    });
    
    y += 5;
    if (y > pageHeight - 80) { pdf.addPage(); y = 20; }
    
    const totalMateriel = parseFloat(document.getElementById('totalMaterielHT').textContent);
    const totalMO = parseFloat(document.getElementById('totalMOHT').textContent);
    const totalServices = parseFloat(document.getElementById('totalServicesHT').textContent);
    const deplacement = parseFloat(document.getElementById('totalDeplacement').textContent);
    const sousTotalHT = totalMateriel + totalMO + totalServices + deplacement;
    const buildingAge = document.querySelector('input[name="buildingAge"]:checked').value;
    const tva = buildingAge === 'old' ? 0.06 : 0.21;
    const tvaPercent = (tva * 100).toFixed(0);
    const ristourneEnabled = document.getElementById('ristourneEnabled').checked;
    let montantRistourne = 0;
    let pourcent = 0;
    let delai = 0;
    
    if (ristourneEnabled) {
        pourcent = parseFloat(document.getElementById('ristournePourcent').value) || 15;
        delai = parseInt(document.getElementById('ristourneDelai').value) || 30;
        montantRistourne = sousTotalHT * (pourcent / 100);
    }
    
    const sousTotalApresRistourne = sousTotalHT - montantRistourne;
    const montantTVA = sousTotalApresRistourne * tva;
    const totalTTC = sousTotalApresRistourne + montantTVA;
    
    pdf.setFillColor(25, 55, 109);
    pdf.rect(20, y, pageWidth - 40, 28, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'bold');
    pdf.text('SOUS-TOTAL HT:', 25, y + 8);
    pdf.text(sousTotalHT.toFixed(2) + '‚Ç¨', pageWidth - 25, y + 8, { align: 'right' });
    pdf.text(`TVA (${tvaPercent}%):`, 25, y + 15);
    pdf.text((sousTotalHT * tva).toFixed(2) + '‚Ç¨', pageWidth - 25, y + 15, { align: 'right' });
    pdf.setFontSize(14);
    pdf.text('TOTAL TTC:', 25, y + 24);
    pdf.text((sousTotalHT * (1 + tva)).toFixed(2) + '‚Ç¨', pageWidth - 25, y + 24, { align: 'right' });
    y += 33;
    
    if (ristourneEnabled) {
        y += 5;
        pdf.setFillColor(255, 243, 205);
        pdf.rect(20, y, pageWidth - 40, 32, 'F');
        pdf.setTextColor(133, 100, 4);
        pdf.setFontSize(11);
        pdf.setFont(undefined, 'bold');
        pdf.text('üéÅ OFFRE SPECIALE', 25, y + 7);
        pdf.setFont(undefined, 'normal');
        pdf.setFontSize(9);
        const dateLimite = new Date();
        dateLimite.setDate(dateLimite.getDate() + delai);
        const dateLimiteStr = dateLimite.toLocaleDateString('fr-FR');
        const economieClientTTC = (sousTotalHT * (1 + tva)) - totalTTC;
        pdf.text(`Ristourne de ${pourcent}% (${montantRistourne.toFixed(2)}‚Ç¨ HT) valable ${delai} jours`, 25, y + 13);
        pdf.text(`(jusqu'au ${dateLimiteStr} inclus)`, 25, y + 18);
        pdf.setFont(undefined, 'bold');
        pdf.setFontSize(11);
        pdf.text(`Prix final apr√®s ristourne : ${totalTTC.toFixed(2)}‚Ç¨ TTC`, 25, y + 24);
        pdf.setFontSize(8);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Soit une √©conomie totale de ${economieClientTTC.toFixed(2)}‚Ç¨ TTC`, 25, y + 29);
        y += 37;
    }
    
    y += 5;
    if (y > pageHeight - 50) { pdf.addPage(); y = 20; }
    pdf.setFillColor(240, 240, 240);
    pdf.rect(20, y, pageWidth - 40, 45, 'F');
    pdf.setTextColor(25, 55, 109);
    pdf.setFontSize(11);
    pdf.setFont(undefined, 'bold');
    pdf.text('MODALITES DE PAIEMENT', 25, y + 7);
    pdf.setTextColor(0, 0, 0);
    pdf.setFont(undefined, 'normal');
    pdf.setFontSize(9);
    const totalFinal = totalTTC;
    const acompte30 = totalFinal * 0.30;
    const debut40 = totalFinal * 0.40;
    const fin30 = totalFinal * 0.30;
    pdf.text(`- Acompte de 30% : ${acompte30.toFixed(2)}‚Ç¨`, 25, y + 14);
    pdf.text(`- 40% au d√©but des travaux : ${debut40.toFixed(2)}‚Ç¨`, 25, y + 19);
    pdf.text(`- 30% √† la fin : ${fin30.toFixed(2)}‚Ç¨`, 25, y + 24);
    pdf.setFont(undefined, 'bold');
    pdf.text(`Titulaire : ${companyInfo.titulaire}`, 25, y + 31);
    pdf.text(`IBAN : ${companyInfo.iban}`, 25, y + 36);
    const devisNum = 'DEVIS-' + Math.random().toString(36).substring(2, 8).toUpperCase();
    pdf.text(`Communication : ${devisNum}`, 25, y + 41);
    
    const fileName = 'Devis_' + (document.getElementById('clientName').value || 'Client').replace(/\s/g, '_') + '_' + today.replace(/\//g, '-') + '.pdf';
    pdf.save(fileName);
    await saveDevis();
    alert('‚úÖ PDF g√©n√©r√© et devis sauvegard√© !');
}

window.saveDevis = async function() {
    if (!currentUser) return;
    const clientData = {
        nom: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        telephone: document.getElementById('clientPhone').value,
        tva: document.getElementById('clientTVA').value,
        adresse: `${document.getElementById('clientRue').value}, ${document.getElementById('clientCP').value} ${document.getElementById('clientCommune').value}`
    };
    if (!clientData.nom) { alert('Nom client requis'); return; }

    try {
        const clientRef = await addDoc(collection(db, 'clients'), {
            userId: currentUser.uid,
            ...clientData,
            createdAt: new Date().toISOString()
        });

        await addDoc(collection(db, 'devis'), {
            userId: currentUser.uid,
            clientId: clientRef.id,
            client: clientData,
            batiment: {
                type: document.querySelector('input[name="projectType"]:checked').value,
                age: document.querySelector('input[name="buildingAge"]:checked').value
            },
            rooms: devisState.rooms,
            ristourne: {
                enabled: document.getElementById('ristourneEnabled').checked,
                pourcent: parseFloat(document.getElementById('ristournePourcent').value) || 0,
                delai: parseInt(document.getElementById('ristourneDelai').value) || 30
            },
            totaux: {
                materielHT: parseFloat(document.getElementById('totalMaterielHT').textContent),
                moHT: parseFloat(document.getElementById('totalMOHT').textContent),
                servicesHT: parseFloat(document.getElementById('totalServicesHT').textContent),
                totalTTC: parseFloat(document.getElementById('totalTTC').textContent)
            },
            status: 'pending',
            createdAt: new Date().toISOString()
        });

        alert('‚úÖ Devis sauvegard√© !');
        window.location.href = 'mes-devis.html';
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur sauvegarde');
    }
}
```

</script>
</body>
</html>
