<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevTech - Cr√©er un Devis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .back-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .nav-item {
            background: white;
            border: none;
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 100px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .nav-icon {
            font-size: 24px;
            text-align: center;
            margin-bottom: 5px;
        }

        .nav-label {
            text-align: center;
            font-size: 13px;
            font-weight: 600;
        }

        .page {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subsection-title {
            font-size: 18px;
            color: #667eea;
            margin: 25px 0 15px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .option-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .option-card {
            background: #f8f9fa;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
        }

        .option-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option-card input[type="radio"] {
            display: none;
        }

        .card-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .card-subtitle {
            font-size: 14px;
            color: #666;
        }

        .room-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .room-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .delete-room-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .article-selector {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .article-selector select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .article-selector input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
        }

        .add-article-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .articles-list {
            margin-top: 20px;
        }

        .article-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-block {
            width: 100%;
            margin-top: 20px;
        }

        .recap-card {
            background: #f0f4ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .recap-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .recap-row:last-child {
            border-bottom: none;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }

            .nav-menu {
                gap: 5px;
            }

            .nav-item {
                min-width: 80px;
                padding: 10px;
            }

            .article-selector,
            .article-item {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="logo">‚ö° DEVTECH</div>
            <a href="app-complet.html" class="back-btn">‚Üê Retour</a>
        </header>

        <!-- NAVIGATION -->
        <nav class="nav-menu">
            <button class="nav-item active" data-page="client" onclick="switchPage('client')">
                <div class="nav-icon">üë§</div>
                <div class="nav-label">Client</div>
            </button>
            <button class="nav-item" data-page="travaux" onclick="switchPage('travaux')">
                <div class="nav-icon">üî®</div>
                <div class="nav-label">Travaux</div>
            </button>
            <button class="nav-item" data-page="tableau" onclick="switchPage('tableau')">
                <div class="nav-icon">‚ö°</div>
                <div class="nav-label">Tableau</div>
            </button>
            <button class="nav-item" data-page="recapitulatif" onclick="switchPage('recapitulatif')">
                <div class="nav-icon">üí∞</div>
                <div class="nav-label">R√©cap</div>
            </button>
        </nav>

        <!-- PAGE CLIENT -->
        <div id="page-client" class="page active">
            <h2 class="section-title">üë§ Informations Client</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom complet *</label>
                    <input type="text" id="clientName" placeholder="Jean Dupont">
                </div>
                <div class="form-group">
                    <label>T√©l√©phone</label>
                    <input type="tel" id="clientPhone" placeholder="+32 475 12 34 56">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail" placeholder="jean@email.com">
                </div>
                <div class="form-group">
                    <label>N¬∞ TVA (optionnel)</label>
                    <input type="text" id="clientTVA" placeholder="BE 0123.456.789">
                </div>
                <div class="form-group">
                    <label>Rue et num√©ro *</label>
                    <input type="text" id="clientRue" placeholder="Rue de la Paix 123">
                </div>
                <div class="form-group">
                    <label>Code postal</label>
                    <input type="text" id="clientCP" placeholder="1000">
                </div>
                <div class="form-group">
                    <label>Commune *</label>
                    <input type="text" id="clientCommune" placeholder="Bruxelles">
                </div>
            </div>

            <h3 class="subsection-title">üè† Type de projet</h3>
            <div class="option-cards">
                <label class="option-card active">
                    <input type="radio" name="projectType" value="residential" checked>
                    <div class="card-icon">üè°</div>
                    <div class="card-title">R√©sidentiel</div>
                    <div class="card-subtitle">Maison, appartement</div>
                </label>
                <label class="option-card">
                    <input type="radio" name="projectType" value="commercial">
                    <div class="card-icon">üè¢</div>
                    <div class="card-title">Commercial</div>
                    <div class="card-subtitle">Bureau, magasin</div>
                </label>
            </div>

            <h3 class="subsection-title">üìÖ √Çge du b√¢timent (d√©termine la TVA)</h3>
            <div class="option-cards">
                <label class="option-card active">
                    <input type="radio" name="buildingAge" value="old" checked>
                    <div class="card-icon">üèöÔ∏è</div>
                    <div class="card-title">> 10 ans</div>
                    <div class="card-subtitle" style="color: #28a745; font-weight: 700;">TVA 6%</div>
                </label>
                <label class="option-card">
                    <input type="radio" name="buildingAge" value="new">
                    <div class="card-icon">üèóÔ∏è</div>
                    <div class="card-title">< 10 ans</div>
                    <div class="card-subtitle" style="color: #dc3545; font-weight: 700;">TVA 21%</div>
                </label>
            </div>

            <button class="btn btn-primary btn-block" onclick="switchPage('travaux')">
                Suivant : Travaux ‚Üí
            </button>
        </div>

        <!-- PAGE TRAVAUX -->
        <div id="page-travaux" class="page">
            <h2 class="section-title">üî® Configuration des Travaux</h2>
            
            <!-- PARAM√àTRES GLOBAUX -->
            <div style="background: #f0f4ff; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <h3>‚öôÔ∏è Param√®tres globaux</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label><strong>Tarif horaire</strong></label>
                        <select id="globalTarif">
                            <option value="50" selected>Mod√©r√© - 50‚Ç¨/h</option>
                            <option value="65">√âlev√© - 65‚Ç¨/h</option>
                            <option value="75">Urgent - 75‚Ç¨/h</option>
                            <option value="90">Week-end - 90‚Ç¨/h</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><strong>D√©placement</strong></label>
                        <select id="globalDeplacement">
                            <option value="20">20‚Ç¨</option>
                            <option value="25" selected>25‚Ç¨</option>
                            <option value="35">35‚Ç¨</option>
                            <option value="0">Gratuit</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- CR√âATION DE PI√àCE -->
            <div style="background: linear-gradient(135deg, #e7f3ff 0%, #d1e7ff 100%); border: 3px solid #667eea; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üè† Cr√©er une nouvelle pi√®ce</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label><strong>Nom de la pi√®ce</strong></label>
                        <input type="text" id="newRoomName" placeholder="Ex: Salon, Cuisine, Chambre 1...">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-success" onclick="createRoom()" style="margin-top: 24px; width: 100%;">
                            ‚ûï Cr√©er cette pi√®ce
                        </button>
                    </div>
                </div>
            </div>

            <!-- LISTE DES PI√àCES -->
            <div id="roomsContainer">
                <div class="empty-state">Cr√©ez une pi√®ce pour commencer</div>
            </div>

            <button class="btn btn-primary btn-block" onclick="switchPage('tableau')">
                Suivant : Tableau √©lectrique ‚Üí
            </button>
        </div>

        <!-- PAGE TABLEAU -->
        <div id="page-tableau" class="page">
            <h2 class="section-title">‚ö° Tableau √âlectrique</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Type de coffret</label>
                    <select id="coffretType">
                        <option value="">S√©lectionner...</option>
                        <option value="2R">2 rang√©es (26 modules) - 45‚Ç¨</option>
                        <option value="3R">3 rang√©es (39 modules) - 55‚Ç¨</option>
                        <option value="4R">4 rang√©es (52 modules) - 65‚Ç¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Disjoncteur de branchement</label>
                    <select id="disjoncteurBranchement">
                        <option value="40A">40A - 85‚Ç¨</option>
                        <option value="63A">63A - 110‚Ç¨</option>
                        <option value="80A">80A - 135‚Ç¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Diff√©rentiel 40A Type AC</label>
                    <input type="number" id="diffAC" value="1" min="0">
                </div>
                <div class="form-group">
                    <label>Diff√©rentiel 40A Type A</label>
                    <input type="number" id="diffA" value="1" min="0">
                </div>
                <div class="form-group">
                    <label>Parafoudre</label>
                    <select id="parafoudre">
                        <option value="non">Non</option>
                        <option value="oui">Oui - 120‚Ç¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Contacteur jour/nuit</label>
                    <input type="number" id="contacteur" value="0" min="0">
                </div>
            </div>

            <button class="btn btn-primary btn-block" onclick="switchPage('recapitulatif')">
                Suivant : R√©capitulatif ‚Üí
            </button>
        </div>

        <!-- PAGE R√âCAPITULATIF -->
        <div id="page-recapitulatif" class="page">
            <h2 class="section-title">üí∞ R√©capitulatif du Devis</h2>
            
            <div id="recapContent">
                <!-- Le r√©capitulatif sera g√©n√©r√© ici -->
            </div>

            <div class="recap-card">
                <div class="recap-row">
                    <span>Total mat√©riel HT :</span>
                    <span id="totalMaterielHT">0.00 ‚Ç¨</span>
                </div>
                <div class="recap-row">
                    <span>Total main d'≈ìuvre HT :</span>
                    <span id="totalMOHT">0.00 ‚Ç¨</span>
                </div>
                <div class="recap-row">
                    <span>D√©placement :</span>
                    <span id="totalDeplacement">25.00 ‚Ç¨</span>
                </div>
                <div class="recap-row">
                    <span>Sous-total HT :</span>
                    <span id="sousTotalHT">0.00 ‚Ç¨</span>
                </div>
                <div class="recap-row">
                    <span>TVA (<span id="tvaPercent">6</span>%) :</span>
                    <span id="montantTVA">0.00 ‚Ç¨</span>
                </div>
                <div class="recap-row">
                    <span>TOTAL TTC :</span>
                    <span id="totalTTC">0.00 ‚Ç¨</span>
                </div>
            </div>

            <button class="btn btn-success btn-block" onclick="saveDevis()">
                üíæ Enregistrer le devis
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, setDoc, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAQ9YFHCYhKG-65rqJp31QEb68F9oY4HFk",
            authDomain: "devtech-20997.firebaseapp.com",
            projectId: "devtech-20997",
            storageBucket: "devtech-20997.firebasestorage.app",
            messagingSenderId: "95961701207",
            appId: "1:95961701207:web:25ac1e97f292c58797bc12",
            measurementId: "G-7S08YYT59J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let devisState = {
            client: {},
            global: { tarif: 50, tva: 0.06, deplacement: 25 },
            rooms: [],
            tableau: {},
            nextRoomId: 1
        };

        let catalogueProduits = [];

        onAuthStateChanged(auth, async (user) => {
            if (!user || !user.emailVerified) {
                window.location.href = 'login-v2.html';
            } else {
                currentUser = user;
                await loadCatalogueProduits();
            }
        });

        async function loadCatalogueProduits() {
            try {
                // Charger les prix personnalis√©s de l'utilisateur
                const pricesDoc = await getDoc(doc(db, 'user_prices', currentUser.uid));
                const customPrices = pricesDoc.exists() ? pricesDoc.data() : {};

                // Catalogue par d√©faut
                catalogueProduits = [
                    { ref: 'PR-SIM-001', name: 'Prise simple 16A', price: customPrices['PR-SIM-001'] || 3.50, temps: 0.3, category: 'Prises' },
                    { ref: 'PR-DOU-001', name: 'Prise double 16A', price: customPrices['PR-DOU-001'] || 5.80, temps: 0.3, category: 'Prises' },
                    { ref: 'INT-SIM-001', name: 'Interrupteur simple', price: customPrices['INT-SIM-001'] || 2.80, temps: 0.25, category: 'Interrupteurs' },
                    { ref: 'INT-VAE-001', name: 'Va-et-vient', price: customPrices['INT-VAE-001'] || 3.20, temps: 0.4, category: 'Interrupteurs' },
                    { ref: 'LED-SP6-001', name: 'Spot LED 6W', price: customPrices['LED-SP6-001'] || 8.50, temps: 0.3, category: '√âclairage' },
                    { ref: 'LED-SP10-001', name: 'Spot LED 10W', price: customPrices['LED-SP10-001'] || 12.00, temps: 0.3, category: '√âclairage' }
                ];

                console.log('Catalogue charg√©:', catalogueProduits.length, 'produits');
            } catch (error) {
                console.error('Erreur chargement catalogue:', error);
            }
        }

        window.switchPage = function(pageName) {
            // D√©sactiver tous les nav-items et pages
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            // Activer le nav-item et la page s√©lectionn√©s
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
            document.getElementById(`page-${pageName}`).classList.add('active');

            // Si on va sur r√©cap, calculer
            if (pageName === 'recapitulatif') {
                calculateRecap();
            }
        }

        // Gestion des cards
        document.querySelectorAll('.option-card').forEach(card => {
            card.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        window.createRoom = function() {
            const roomName = document.getElementById('newRoomName').value.trim();
            if (!roomName) {
                alert('Veuillez entrer un nom de pi√®ce');
                return;
            }

            const room = {
                id: devisState.nextRoomId++,
                name: roomName,
                articles: []
            };

            devisState.rooms.push(room);
            document.getElementById('newRoomName').value = '';
            renderRooms();
        }

        function renderRooms() {
            const container = document.getElementById('roomsContainer');
            
            if (devisState.rooms.length === 0) {
                container.innerHTML = '<div class="empty-state">Cr√©ez une pi√®ce pour commencer</div>';
                return;
            }

            container.innerHTML = devisState.rooms.map(room => `
                <div class="room-card">
                    <div class="room-header">
                        <div class="room-title">üìç ${room.name}</div>
                        <button class="delete-room-btn" onclick="deleteRoom(${room.id})">üóëÔ∏è Supprimer</button>
                    </div>

                    <div class="article-selector">
                        <select id="article-select-${room.id}">
                            <option value="">S√©lectionner un article...</option>
                            ${catalogueProduits.map(p => `
                                <option value="${p.ref}">${p.name} - ${p.price.toFixed(2)}‚Ç¨</option>
                            `).join('')}
                        </select>
                        <input type="number" id="qty-${room.id}" placeholder="Qt√©" value="1" min="1">
                        <button class="add-article-btn" onclick="addArticleToRoom(${room.id})">‚ûï Ajouter</button>
                    </div>

                    <div class="articles-list" id="articles-${room.id}">
                        ${room.articles.map((article, idx) => `
                            <div class="article-item">
                                <div>${article.name}</div>
                                <div>${article.qty}x</div>
                                <div>${article.price.toFixed(2)}‚Ç¨</div>
                                <div>${(article.qty * article.price).toFixed(2)}‚Ç¨</div>
                                <button onclick="deleteArticle(${room.id}, ${idx})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">üóëÔ∏è</button>
                            </div>
                        `).join('') || '<div style="text-align: center; color: #999; padding: 20px;">Aucun article ajout√©</div>'}
                    </div>
                </div>
            `).join('');
        }

        window.addArticleToRoom = function(roomId) {
            const room = devisState.rooms.find(r => r.id === roomId);
            if (!room) return;

            const articleRef = document.getElementById(`article-select-${roomId}`).value;
            const qty = parseInt(document.getElementById(`qty-${roomId}`).value) || 1;

            if (!articleRef) {
                alert('Veuillez s√©lectionner un article');
                return;
            }

            const produit = catalogueProduits.find(p => p.ref === articleRef);
            if (!produit) return;

            room.articles.push({
                ref: produit.ref,
                name: produit.name,
                price: produit.price,
                temps: produit.temps,
                qty: qty
            });

            renderRooms();
        }

        window.deleteRoom = function(roomId) {
            if (confirm('Supprimer cette pi√®ce ?')) {
                devisState.rooms = devisState.rooms.filter(r => r.id !== roomId);
                renderRooms();
            }
        }

        window.deleteArticle = function(roomId, articleIdx) {
            const room = devisState.rooms.find(r => r.id === roomId);
            if (room) {
                room.articles.splice(articleIdx, 1);
                renderRooms();
            }
        }

        function calculateRecap() {
            const tarif = parseFloat(document.getElementById('globalTarif').value);
            const deplacement = parseFloat(document.getElementById('globalDeplacement').value);
            const buildingAge = document.querySelector('input[name="buildingAge"]:checked').value;
            const tva = buildingAge === 'old' ? 0.06 : 0.21;

            let totalMateriel = 0;
            let totalTemps = 0;

            devisState.rooms.forEach(room => {
                room.articles.forEach(article => {
                    totalMateriel += article.price * article.qty;
                    totalTemps += article.temps * article.qty;
                });
            });

            const totalMO = totalTemps * tarif;
            const sousTotalHT = totalMateriel + totalMO + deplacement;
            const montantTVA = sousTotalHT * tva;
            const totalTTC = sousTotalHT + montantTVA;

            document.getElementById('totalMaterielHT').textContent = totalMateriel.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalMOHT').textContent = totalMO.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalDeplacement').textContent = deplacement.toFixed(2) + ' ‚Ç¨';
            document.getElementById('sousTotalHT').textContent = sousTotalHT.toFixed(2) + ' ‚Ç¨';
            document.getElementById('tvaPercent').textContent = (tva * 100).toFixed(0);
            document.getElementById('montantTVA').textContent = montantTVA.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';

            // R√©cap content
            document.getElementById('recapContent').innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>üë§ Client</h3>
                    <p><strong>${document.getElementById('clientName').value || 'Non renseign√©'}</strong></p>
                    <p>${document.getElementById('clientEmail').value || ''}</p>
                    <p>${document.getElementById('clientPhone').value || ''}</p>
                </div>

                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>üìç Pi√®ces (${devisState.rooms.length})</h3>
                    ${devisState.rooms.map(room => `
                        <p><strong>${room.name}</strong> - ${room.articles.length} articles</p>
                    `).join('')}
                </div>
            `;
        }

        window.saveDevis = async function() {
            if (!currentUser) return;

            const clientData = {
                nom: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                telephone: document.getElementById('clientPhone').value,
                tva: document.getElementById('clientTVA').value,
                adresse: `${document.getElementById('clientRue').value}, ${document.getElementById('clientCP').value} ${document.getElementById('clientCommune').value}`
            };

            if (!clientData.nom) {
                alert('Veuillez renseigner au moins le nom du client');
                return;
            }

            try {
                // Sauvegarder le client
                const clientRef = await addDoc(collection(db, 'clients'), {
                    userId: currentUser.uid,
                    ...clientData,
                    createdAt: new Date().toISOString()
                });

                // Calculer totaux
                const tarif = parseFloat(document.getElementById('globalTarif').value);
                const deplacement = parseFloat(document.getElementById('globalDeplacement').value);
                const buildingAge = document.querySelector('input[name="buildingAge"]:checked').value;
                const tva = buildingAge === 'old' ? 0.06 : 0.21;

                let totalMateriel = 0;
                let totalTemps = 0;
                devisState.rooms.forEach(room => {
                    room.articles.forEach(article => {
                        totalMateriel += article.price * article.qty;
                        totalTemps += article.temps * article.qty;
                    });
                });

                const totalMO = totalTemps * tarif;
                const sousTotalHT = totalMateriel + totalMO + deplacement;
                const totalTTC = sousTotalHT * (1 + tva);

                // Sauvegarder le devis
                const devisRef = await addDoc(collection(db, 'devis'), {
                    userId: currentUser.uid,
                    clientId: clientRef.id,
                    client: clientData,
                    batiment: {
                        type: document.querySelector('input[name="projectType"]:checked').value,
                        buildingAge: buildingAge
                    },
                    pieces: devisState.rooms,
                    tableau: {
                        coffret: document.getElementById('coffretType').value,
                        disjoncteur: document.getElementById('disjoncteurBranchement').value
                    },
                    totaux: {
                        materielHT: totalMateriel,
                        moHT: totalMO,
                        deplacement: deplacement,
                        totalTTC: totalTTC
                    },
                    status: 'draft',
                    createdAt: new Date().toISOString()
                });

                alert('‚úÖ Devis cr√©√© avec succ√®s!\nR√©f√©rence: ' + devisRef.id.substring(0, 8).toUpperCase());
                window.location.href = 'mes-devis.html';

            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la cr√©ation du devis');
            }
        }
    </script>
</body>
</html>
